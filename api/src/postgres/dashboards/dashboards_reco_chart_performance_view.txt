CREATE MATERIALIZED VIEW IF NOT EXISTS dashboards_reco_chart_performance_view AS
    WITH months AS (
        SELECT unnest(ARRAY['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']) AS month
    ),
    colors AS (
        SELECT generate_random_colors(COALESCE((SELECT COUNT(id) FROM reco_view), 1) * 30) AS color
    )
        
    SELECT 
        CONCAT(a.year, '-', a.reco_id) AS id,
        a.year,
        a.reco_id,
        jsonb_build_object(
            'absisseLabels', (SELECT jsonb_agg(month) FROM months),
            'datasets', jsonb_build_array(
                jsonb_build_object(
                    'label','Adult',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[1],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[1],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM adult_data_view GROUP BY month, year
                        ) dt ON dt.month = m.month AND dt.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','PF',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[2],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[2],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM family_planning_data_view GROUP BY month, year
                        ) fp ON fp.month = m.month AND fp.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Nouveau Né',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[3],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[3],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM newborn_data_view GROUP BY month, year
                        ) nb ON nb.month = m.month AND nb.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Pcimne',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[4],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[4],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM pcimne_data_view GROUP BY month, year
                        ) pc ON pc.month = m.month AND pc.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Enceinte',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[5],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[5],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM pregnant_data_view GROUP BY month, year
                        ) preg ON preg.month = m.month AND preg.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Accouchement',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[6],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[6],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM delivery_data_view GROUP BY month, year
                        ) del ON del.month = m.month AND del.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Suivi Référence',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[7],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[7],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM referal_data_view GROUP BY month, year
                        ) ref ON ref.month = m.month AND ref.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Décès',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[8],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[8],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM death_data_view GROUP BY month, year
                        ) dth ON dth.month = m.month AND dth.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Evenements',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[9],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[9],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM events_data_view GROUP BY month, year
                        ) ev ON ev.month = m.month AND ev.year = a.year
                    )
                ),
                jsonb_build_object(
                    'label','Activités Promotionnelles',
                    'backgroundColor', (SELECT color FROM colors LIMIT 1)[10],
                    'borderColor', (SELECT color FROM colors LIMIT 1)[10],
                    'data', (
                        SELECT jsonb_agg(COALESCE(count, 0) ORDER BY m.month, year) 
                        FROM months m
                        LEFT JOIN (
                            SELECT month, year, COUNT(id) AS count FROM promotional_data_view GROUP BY month, year
                        ) pm ON pm.month = m.month AND pm.year = a.year
                    )
                )
            )
        ) AS chart,
        
        jsonb_build_object('id', MAX(r.id), 'name', MAX(r.name), 'phone', MAX(r.phone)) AS reco,
        jsonb_build_object('id', MAX(c.id), 'name', MAX(c.name)) AS country,
        jsonb_build_object('id', MAX(g.id), 'name', MAX(g.name)) AS region,
        jsonb_build_object('id', MAX(p.id), 'name', MAX(p.name)) AS prefecture,
        jsonb_build_object('id', MAX(m.id), 'name', MAX(m.name)) AS commune,
        jsonb_build_object('id', MAX(h.id), 'name', MAX(h.name)) AS hospital,
        jsonb_build_object('id', MAX(d.id), 'name', MAX(d.name)) AS district_quartier,
        jsonb_build_object('id', MAX(v.id), 'name', MAX(v.name)) AS village_secteur

    FROM year_month_reco_grid_view a
    
        JOIN reco_view r ON r.id = a.reco_id
        LEFT JOIN country_view c ON r.country_id = c.id 
        LEFT JOIN region_view g ON r.region_id = g.id 
        LEFT JOIN prefecture_view p ON r.prefecture_id = p.id 
        LEFT JOIN commune_view m ON r.commune_id = m.id 
        LEFT JOIN hospital_view h ON r.hospital_id = h.id 
        LEFT JOIN district_quartier_view d ON r.district_quartier_id = d.id 
        LEFT JOIN village_secteur_view v ON r.village_secteur_id = v.id 

    GROUP BY a.reco_id, a.year;
 
