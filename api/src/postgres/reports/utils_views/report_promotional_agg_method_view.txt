CREATE MATERIALIZED VIEW IF NOT EXISTS report_promotional_agg_method_view AS
    SELECT
        reco_id,
        month,
        year,
        domains,
        themes,
        method,
        sex,
        SUM(CASE WHEN value IS NOT NULL AND value > 0 THEN value ELSE 0 END) AS total
    FROM (
        SELECT
            reco_id,
            month,
            year,
            activity_domains AS domains,
            activity_themes AS themes,
            CASE 
                WHEN is_vad_method THEN 'vad'
                WHEN is_talk_method THEN 'talk'
                WHEN is_interpersonal_talk_method THEN 'personal'
            END AS method,
            'F' AS sex,
            women_number AS value
        FROM promotional_data_view
        WHERE women_number IS NOT NULL AND (is_vad_method OR is_talk_method OR is_interpersonal_talk_method)

        UNION ALL

        SELECT
            reco_id,
            month,
            year,
            activity_domains AS domains,
            activity_themes AS themes,
            CASE 
                WHEN is_vad_method THEN 'vad'
                WHEN is_talk_method THEN 'talk'
                WHEN is_interpersonal_talk_method THEN 'personal'
            END AS method,
            'M' AS sex,
            men_number AS value
        FROM promotional_data_view
        WHERE men_number IS NOT NULL AND (is_vad_method OR is_talk_method OR is_interpersonal_talk_method)
    ) sub
    WHERE activity_domains IS NOT NULL AND activity_themes IS NOT NULL AND method IS NOT NULL
    GROUP BY reco_id, month, year, activity_domains, activity_themes, method, sex;
